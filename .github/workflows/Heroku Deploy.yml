name: Heroku Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version

      - name: Detect Changes and Deploy
        run: |
          # Definir el directorio base
          BASE_DIR="."

          # Lista de servicios y apps
          declare -A services
          services=(
            ["administrative-management/availability-log-service"]="app-name-service1"
            ["administrative-management/user-log-service"]="app-name-service2"
            ["administrative-management/reservation-log-service"]="app-name-service3"
            ["administrative-management/facilities-log-service"]="app-name-service4"
            ["availability-management/create-availability-service"]="app-name-base1"
            ["availability-management/delete-availability-service"]="app-name-base2"
            ["availability-management/update-availability-service"]="app-name-base3"
            ["availability-management/list-availability-servicePy"]="app-name-base4"
            ["booking-management/create-reservation-service"]="app-name-base4"
            ["booking-management/cancel-reservation-service"]="app-name-base4"
            ["booking-management/Go_delete-reservation-service"]="app-name-base4"
            ["booking-management/history-reservation-service"]="app-name-base4"
            ["facilities-management/create-facilities-service"]="app-name-base4"
            ["facilities-management/delete-facilities-service"]="app-name-base4"
            ["facilities-management/update-facilities-service"]="app-name-base4"
            ["facilities-management/list-facilities-service"]="app-name-base4"
            ["user-management/create-user-service"]="app-name-base4"
            ["user-management/login-service"]="app-name-base4"
            ["user-management/logout-user-service"]="app-name-base4"
            ["user-management/websocket-service"]="app-name-base4"
            ["frontend"]="app-name-frontend"
          )

          for dir in "${!services[@]}"; do
            cd "$BASE_DIR/$dir"
            if [ $(git diff --name-only HEAD~1 | grep -e '^path/to/$dir/' | wc -l) -gt 0 ]; then
              echo "Changes detected in $dir, deploying to Heroku app ${services[$dir]}"
              git remote add heroku https://git.heroku.com/${services[$dir]}.git
              git push heroku master
              heroku ps --app ${services[$dir]}
              heroku logs --tail --app ${services[$dir]}
            else
              echo "No changes detected in $dir"
            fi
            cd "$BASE_DIR"
          done
        env:
          HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
