name: Heroku Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version

      - name: Detect Changes and Deploy
        run: |
          # Definir el directorio base
          BASE_DIR="$(pwd)"

          # Lista de servicios y apps
          declare -A services
          services=(
            ["administrative-management/availability-log-service"]="app-name-service1"
            ["administrative-management/user-log-service"]="app-name-service2"
            ["administrative-management/reservation-log-service"]="app-name-service3"
            ["administrative-management/facilities-log-service"]="app-name-service4"
            ["availability-management/create-availability-service"]="app-name-base1"
            ["availability-management/delete-availability-service"]="app-name-base2"
            ["availability-management/update-availability-service"]="app-name-base3"
            ["availability-management/list-availability-servicePy"]="app-name-base4"
            ["booking-management/create-reservations-service"]="app-name-base4"
            ["booking-management/cancel-reservations-service"]="app-name-base4"
            ["booking-management/Go_delete-reservations-service"]="app-name-base4"
            ["booking-management/history-reservations-service"]="app-name-base4"
            ["facilities-management/create-facilities-service"]="microservice-create-facilities"
            ["facilities-management/delete-facilities-service"]="app-name-base4"
            ["facilities-management/update-facilities-service"]="app-name-base4"
            ["facilities-management/list-facilities-service"]="app-name-base4"
            ["user-management/create-user-service"]="microservice-create-users"
            ["user-management/login-service"]="microservice-login"
            ["user-management/logout-user-service"]="microservice-logout"
            ["user-management/wobsocket-service"]="microservice-websocket"
            ["frontend"]="app-name-frontend"
          )

          # Iterar sobre los servicios para verificar cambios y desplegar
          for dir in "${!services[@]}"; do
            if [ -d "$BASE_DIR/$dir" ]; then
              echo "Checking directory $dir"
              cd "$BASE_DIR/$dir" || exit 1
              
              # Verificar si hay cambios en el directorio
              if [ $(git diff --name-only HEAD~1 | grep -e "^$dir" | wc -l) -gt 0 ]; then
                echo "Changes detected in $dir, deploying to Heroku app ${services[$dir]}"
                git remote add heroku https://git.heroku.com/${services[$dir]}.git
                git push heroku master
                heroku ps --app ${services[$dir]}
                heroku logs --tail --app ${services[$dir]}
              else
                echo "No changes detected in $dir"
              fi

              # Volver al directorio base
              cd "$BASE_DIR" || exit 1
            else
              echo "Directory $dir does not exist"
            fi
          done
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
